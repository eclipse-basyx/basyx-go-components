// Package api implements the HTTP-facing service logic for the
// Asset Administration Shell Registry of Infrastructures (RoI).
//
// This file provides an implementation of the autogenerated API service
// interface and contains the business logic glue between HTTP input and the
// persistence backend (see `internal/registryofinfrastructuresservice/persistence`).
//
// The service is responsible for common tasks such as:
//   - decoding/validating request path and query parameters
//   - invoking the backend for CRUD operations on InfrastructureDescriptor objects
//   - mapping backend errors to appropriate HTTP error responses
//   - encoding paged results and response payloads
//
// Exported functionality includes the `RegistryOfInfrastructuresAPIAPIService`
// type, which exposes methods for listing, creating, reading, updating and
// deleting Infrastructure Descriptors. The service expects a backend implementing
// `registryofinfrastructurespostgresql.PostgreSQLRegistryOfInfrastructuresDatabase` that
// provides the actual persistence logic.
package api

import (
	"context"
	"errors"
	"log"
	"net/http"
	"strings"

	"github.com/eclipse-basyx/basyx-go-components/internal/common"
	"github.com/eclipse-basyx/basyx-go-components/internal/common/model"
	registryofinfrastructurespostgresql "github.com/eclipse-basyx/basyx-go-components/internal/registryofinfrastructuresservice/persistence"
)

const (
	componentName = "ROI"
)

// RegistryOfInfrastructuresAPIAPIService is a service that implements the logic for the RegistryOfInfrastructuresAPIAPIService
// This service should implement the business logic for every endpoint for the AssetAdministrationShellRegistryOfInfrastructuresAPIAPI API.
// Include any external packages or services that will be required by this service.
type RegistryOfInfrastructuresAPIAPIService struct {
	registryOfInfrastructuresBackend registryofinfrastructurespostgresql.PostgreSQLRegistryOfInfrastructuresDatabase
}

// NewRegistryOfInfrastructuresAPIAPIService creates a default api service
func NewRegistryOfInfrastructuresAPIAPIService(registryOfInfrastructuresBackend registryofinfrastructurespostgresql.PostgreSQLRegistryOfInfrastructuresDatabase) *RegistryOfInfrastructuresAPIAPIService {
	return &RegistryOfInfrastructuresAPIAPIService{
		registryOfInfrastructuresBackend: registryOfInfrastructuresBackend,
	}
}

// GetAllInfrastructureDescriptors - Returns all Infrastructure Descriptors
func (s *RegistryOfInfrastructuresAPIAPIService) GetAllInfrastructureDescriptors(ctx context.Context, limit int32, cursor string, company string, endpointInterface string) (model.ImplResponse, error) {
	var internalCursor string
	if strings.TrimSpace(cursor) != "" {
		dec, decErr := common.DecodeString(cursor)
		if decErr != nil {
			log.Printf("üìç [%s] Error in GetAllInfrastructureDescriptors: decode cursor=%q limit=%d company=%q endpointInterface=%q: %v", componentName, cursor, limit, company, endpointInterface, decErr)
			return common.NewErrorResponse(
				decErr, http.StatusBadRequest, componentName, "GetAllInfrastructureDescriptors", "BadCursor",
			), nil
		}
		internalCursor = dec
	}
	aasds, nextCursor, err := s.registryOfInfrastructuresBackend.ListInfrastructureDescriptors(ctx, limit, internalCursor, company, endpointInterface)
	if err != nil {
		log.Printf("üìç [%s] Error in GetAllInfrastructureDescriptors: list failed (limit=%d cursor=%q company=%q endpointInterface=%q): %v", componentName, limit, internalCursor, company, endpointInterface, err)
		switch {
		case common.IsErrBadRequest(err):
			return common.NewErrorResponse(
				err, http.StatusBadRequest, componentName, "GetAllInfrastructureDescriptors", "BadRequest",
			), nil
		default:
			return common.NewErrorResponse(
				err, http.StatusInternalServerError, componentName, "GetAllInfrastructureDescriptors", "InternalServerError",
			), err
		}
	}

	pm := model.PagedResultPagingMetadata{}
	if nextCursor != "" {
		pm.Cursor = common.EncodeString(nextCursor)
	}
	res := interface{}(struct {
		PagingMetadata interface{}
		Result         interface{}
	}{
		PagingMetadata: pm,
		Result:         aasds,
	})
	return model.Response(http.StatusOK, res), nil
}

// PostInfrastructureDescriptor - Creates a new Infrastructure Descriptor, i.e. registers a Registry
func (s *RegistryOfInfrastructuresAPIAPIService) PostInfrastructureDescriptor(ctx context.Context, infrastructureDescriptor model.InfrastructureDescriptor) (model.ImplResponse, error) {
	err := s.registryOfInfrastructuresBackend.InsertInfrastructureDescriptor(ctx, infrastructureDescriptor)
	if err != nil {
		switch {
		case common.IsErrBadRequest(err):
			log.Printf("üìç [%s] Error in InsertInfrastructureDescriptor: bad request (aasId=%q): %v", componentName, infrastructureDescriptor.Id, err)
			return common.NewErrorResponse(
				err, http.StatusBadRequest, componentName, "InsertInfrastructureDescriptor", "BadRequest",
			), nil
		case common.IsErrConflict(err):
			log.Printf("üìç [%s] Error in InsertInfrastructureDescriptor: conflict (aasId=%q): %v", componentName, infrastructureDescriptor.Id, err)
			return common.NewErrorResponse(
				err, http.StatusConflict, componentName, "InsertInfrastructureDescriptor", "Conflict",
			), nil
		default:
			log.Printf("üìç [%s] Error in InsertInfrastructureDescriptor: internal (aasId=%q): %v", componentName, infrastructureDescriptor.Id, err)
			return common.NewErrorResponse(
				err, http.StatusInternalServerError, componentName, "InsertInfrastructureDescriptor", "Unhandled",
			), err
		}
	}

	return model.Response(http.StatusCreated, infrastructureDescriptor), nil
}

// GetInfrastructureDescriptorById - Returns a specific Infrastructure Descriptor
// nolint:revive // defined by standard
func (s *RegistryOfInfrastructuresAPIAPIService) GetInfrastructureDescriptorById(ctx context.Context, infrastructureIdentifier string) (model.ImplResponse, error) {
	decoded, decodeErr := common.DecodeString(infrastructureIdentifier)
	if decodeErr != nil {
		log.Printf("üìç [%s] Error in GetInfrastructureDescriptorById: decode infrastructureIdentifier=%q: %v", componentName, infrastructureIdentifier, decodeErr)
		return common.NewErrorResponse(
			decodeErr, http.StatusBadRequest, componentName, "GetInfrastructureDescriptorById", "BadRequest-Decode",
		), nil
	}

	result, err := s.registryOfInfrastructuresBackend.GetInfrastructureDescriptorByID(ctx, decoded)

	if err != nil {
		switch {
		case common.IsErrBadRequest(err):
			log.Printf("üìç [%s] Error in GetInfrastructureDescriptorById: bad request (aasId=%q): %v", componentName, string(decoded), err)
			return common.NewErrorResponse(
				err, http.StatusBadRequest, componentName, "GetInfrastructureDescriptorById", "BadRequest",
			), nil
		case common.IsErrNotFound(err):
			log.Printf("üìç [%s] Error in GetInfrastructureDescriptorById: not found (aasId=%q): %v", componentName, string(decoded), err)
			return common.NewErrorResponse(
				err, http.StatusNotFound, componentName, "GetInfrastructureDescriptorById", "NotFound",
			), nil
		default:
			log.Printf("üìç [%s] Error in GetInfrastructureDescriptorById: internal (aasId=%q): %v", componentName, string(decoded), err)
			return common.NewErrorResponse(
				err, http.StatusInternalServerError, componentName, "GetInfrastructureDescriptorById", "Unhandled",
			), err
		}
	}
	return model.Response(http.StatusOK, result), nil
}

// PutInfrastructureDescriptorById - Creates or updates an existing Infrastructure Descriptor
// nolint:revive // defined by standard
func (s *RegistryOfInfrastructuresAPIAPIService) PutInfrastructureDescriptorById(ctx context.Context, infrastructureIdentifier string, infrastructureDescriptor model.InfrastructureDescriptor) (model.ImplResponse, error) {
	// Decode path AAS id
	decodedRegistry, decErr := common.DecodeString(infrastructureIdentifier)
	if decErr != nil {
		log.Printf("üìç [%s] Error in PutInfrastructureDescriptorById: decode infrastructureIdentifier=%q: %v", componentName, infrastructureIdentifier, decErr)
		return common.NewErrorResponse(
			decErr, http.StatusBadRequest, componentName, "PutInfrastructureDescriptorById", "BadRequest-Decode",
		), nil
	}

	// Enforce id consistency with path
	if strings.TrimSpace(infrastructureDescriptor.Id) != "" && infrastructureDescriptor.Id != decodedRegistry {
		log.Printf("üìç [%s] Error in PutInfrastructureDescriptorById: body id does not match path id (body=%q path=%q)", componentName, infrastructureDescriptor.Id, decodedRegistry)
		return common.NewErrorResponse(
			errors.New("body id does not match path id"), http.StatusBadRequest, componentName, "PutInfrastructureDescriptorById", "BadRequest-IdMismatch",
		), nil
	}
	infrastructureDescriptor.Id = decodedRegistry

	existed, err := s.registryOfInfrastructuresBackend.ReplaceInfrastructureDescriptor(ctx, infrastructureDescriptor)
	if err != nil {
		switch {
		case common.IsErrBadRequest(err):
			log.Printf("üìç [%s] Error in PutInfrastructureDescriptorById: bad request (registryId=%q): %v", componentName, decodedRegistry, err)
			return common.NewErrorResponse(
				err, http.StatusBadRequest, componentName, "PutInfrastructureDescriptorById", "BadRequest",
			), nil
		case common.IsErrConflict(err):
			log.Printf("üìç [%s] Error in PutInfrastructureDescriptorById: conflict (registryId=%q): %v", componentName, decodedRegistry, err)
			return common.NewErrorResponse(
				err, http.StatusConflict, componentName, "PutInfrastructureDescriptorById", "Conflict",
			), nil
		default:
			log.Printf("üìç [%s] Error in PutInfrastructureDescriptorById: internal (registryId=%q): %v", componentName, decodedRegistry, err)
			return common.NewErrorResponse(
				err, http.StatusInternalServerError, componentName, "PutInfrastructureDescriptorById", "Unhandled-Insert",
			), err
		}
	}

	if existed {
		return model.Response(http.StatusNoContent, nil), nil
	}
	return model.Response(http.StatusCreated, infrastructureDescriptor), nil
}

// DeleteInfrastructureDescriptorById - Deletes a Infrastructure Descriptor, i.e. de-registers a Registry
// nolint:revive // defined by standard
func (s *RegistryOfInfrastructuresAPIAPIService) DeleteInfrastructureDescriptorById(ctx context.Context, infrastructureIdentifier string) (model.ImplResponse, error) {

	decoded, decodeErr := common.DecodeString(infrastructureIdentifier)
	if decodeErr != nil {
		log.Printf("üìç [%s] Error DeleteInfrastructureDescriptorById: decode aasIdentifier=%q failed: %v", componentName, infrastructureIdentifier, decodeErr)
		return common.NewErrorResponse(
			decodeErr, http.StatusBadRequest, componentName, "DeleteInfrastructureDescriptorById", "BadRequest-Decode",
		), nil
	}

	if err := s.registryOfInfrastructuresBackend.DeleteInfrastructureDescriptorByID(ctx, decoded); err != nil {
		switch {
		case common.IsErrNotFound(err):
			log.Printf("üìç [%s] Error in DeleteInfrastructureDescriptorById: not found (aasId=%q): %v", componentName, decoded, err)
			return common.NewErrorResponse(
				err, http.StatusNotFound, componentName, "DeleteInfrastructureDescriptorById", "NotFound",
			), nil
		case common.IsErrBadRequest(err):
			log.Printf("üìç [%s] Error in DeleteInfrastructureDescriptorById: bad request (aasId=%q): %v", componentName, decoded, err)
			return common.NewErrorResponse(
				err, http.StatusBadRequest, componentName, "DeleteInfrastructureDescriptorById", "BadRequest",
			), nil
		default:
			log.Printf("üìç [%s] Error in DeleteInfrastructureDescriptorById: internal (aasId=%q): %v", componentName, decoded, err)
			return common.NewErrorResponse(
				err, http.StatusInternalServerError, componentName, "DeleteInfrastructureDescriptorById", "Unhandled",
			), err
		}
	}

	return model.Response(http.StatusNoContent, nil), nil
}
