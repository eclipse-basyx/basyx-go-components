name: Podman Healthcheck Smoke

on:
  pull_request:
    paths:
      - 'cmd/**'
      - 'cmd/wget-compat.sh'
      - 'basyxschema.sql'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/podman-healthcheck-smoke.yml'
  push:
    branches: [main]
    paths:
      - 'cmd/**'
      - 'cmd/wget-compat.sh'
      - 'basyxschema.sql'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/podman-healthcheck-smoke.yml'

jobs:
  podman-smoke:
    name: Podman healthcheck smoke (${{ matrix.service.name }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: aasregistryservice
            image: aasregistry-go
            port: 8080
          - name: discoveryservice
            image: aasdiscovery-go
            port: 8080
          - name: digitaltwinregistryservice
            image: digitaltwinregistry-go
            port: 8080
          - name: registryofinfrastructuresservice
            image: registryofinfrastructures-go
            port: 8080
          - name: submodelrepositoryservice
            image: submodelrepository-go
            port: 8080
          - name: submodelregistryservice
            image: submodelregistry-go
            port: 8080
          - name: conceptdescriptionrepositoryservice
            image: conceptdescriptionrepository-go
            port: 8080

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Ensure Podman is available
        run: |
          if ! command -v podman >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y podman
          fi
          podman --version

      - name: Build image with Podman
        run: |
          podman build \
            -t ${{ matrix.service.image }}:podman-smoke \
            -f ./cmd/${{ matrix.service.name }}/Dockerfile \
            .

      - name: Run DB + service and verify healthchecks
        run: |
          set -euo pipefail

          cleanup() {
            podman rm -f service-smoke postgres-smoke >/dev/null 2>&1 || true
            podman network rm basyx-smoke >/dev/null 2>&1 || true
          }
          trap cleanup EXIT

          podman network create basyx-smoke

          podman run -d --name postgres-smoke --network basyx-smoke \
            -e POSTGRES_USER=admin \
            -e POSTGRES_PASSWORD=admin123 \
            -e POSTGRES_DB=basyxTestDB \
            postgres:18

          for i in $(seq 1 30); do
            if podman exec postgres-smoke pg_isready -U admin -d basyxTestDB >/dev/null 2>&1; then
              echo "Postgres is ready"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "Postgres did not become ready in time"
              podman logs postgres-smoke || true
              exit 1
            fi
            sleep 2
          done

          podman run -d --name service-smoke --network basyx-smoke \
            -e SERVER_PORT=${{ matrix.service.port }} \
            -e CORS_ALLOWEDORIGINS='*' \
            -e CORS_ALLOWEDHEADERS='*' \
            -e CORS_ALLOWEDCREDENTIALS=true \
            -e CORS_ALLOWEDMETHODS='GET,POST,PUT,PATCH,DELETE,OPTIONS' \
            -e POSTGRES_HOST=postgres-smoke \
            -e POSTGRES_PORT=5432 \
            -e POSTGRES_USER=admin \
            -e POSTGRES_PASSWORD=admin123 \
            -e POSTGRES_DBNAME=basyxTestDB \
            -e POSTGRES_MAXOPENCONNECTIONS=50 \
            -e POSTGRES_MAXIDLECONNECTIONS=50 \
            -e POSTGRES_CONNMAXLIFETIMEMINUTES=5 \
            -e ABAC_ENABLED=false \
            ${{ matrix.service.image }}:podman-smoke

          for i in $(seq 1 45); do
            if podman healthcheck run service-smoke >/dev/null 2>&1; then
              echo "Image healthcheck passed under Podman"
              break
            fi
            if [ "$i" -eq 45 ]; then
              echo "Image healthcheck did not pass in time"
              podman logs service-smoke || true
              exit 1
            fi
            sleep 2
          done

          podman exec service-smoke /bin/wget --quiet --tries=1 --output-document=- http://127.0.0.1:${{ matrix.service.port }}/health >/dev/null
          echo "Compose-style wget healthcheck command works under Podman"
