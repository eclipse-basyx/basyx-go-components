// Code generated by OpenAPI Generator (https://openapi-generator.tech); DO NOT EDIT.

/*
 * DotAAS Part 2 | HTTP/REST | Submodel Registry Service Specification
 *
 * The Full Profile of the Submodel Registry Service Specification as part of the [Specification of the Asset Administration Shell: Part 2](https://industrialdigitaltwin.org/en/content-hub/aasspecifications).   Copyright: Industrial Digital Twin Association (IDTA) 2025
 *
 * API version: V3.1.1_SSP-001
 * Contact: info@idtwin.org
 */

package smregistryopenapi

import (
	"encoding/json"
	"log"
	"net/http"
	"strings"

	"github.com/eclipse-basyx/basyx-go-components/internal/common"
	"github.com/eclipse-basyx/basyx-go-components/internal/common/model"
	"github.com/go-chi/chi/v5"
)

const (
	componentName = "SMR_VAL"
)

type SubmodelDescriptor = model.SubmodelDescriptor

// SubmodelRegistryAPIAPIController binds http requests to an api service and writes the service results to the http response
type SubmodelRegistryAPIAPIController struct {
	service      SubmodelRegistryAPIAPIServicer
	errorHandler ErrorHandler
	contextPath  string
}

// SubmodelRegistryAPIAPIOption for how the controller is set up.
type SubmodelRegistryAPIAPIOption func(*SubmodelRegistryAPIAPIController)

// WithSubmodelRegistryAPIAPIErrorHandler inject ErrorHandler into controller
func WithSubmodelRegistryAPIAPIErrorHandler(h ErrorHandler) SubmodelRegistryAPIAPIOption {
	return func(c *SubmodelRegistryAPIAPIController) {
		c.errorHandler = h
	}
}

// NewSubmodelRegistryAPIAPIController creates a default api controller
func NewSubmodelRegistryAPIAPIController(s SubmodelRegistryAPIAPIServicer, contextPath string, opts ...SubmodelRegistryAPIAPIOption) *SubmodelRegistryAPIAPIController {
	controller := &SubmodelRegistryAPIAPIController{
		service:      s,
		errorHandler: DefaultErrorHandler,
		contextPath:  contextPath,
	}

	for _, opt := range opts {
		opt(controller)
	}

	return controller
}

// Routes returns all the api routes for the SubmodelRegistryAPIAPIController
func (c *SubmodelRegistryAPIAPIController) Routes() Routes {
	return Routes{
		"GetAllSubmodelDescriptors": Route{
			"GetAllSubmodelDescriptors",
			strings.ToUpper("Get"),
			"/api/v3/submodel-descriptors",
			c.GetAllSubmodelDescriptors,
		},
		"PostSubmodelDescriptor": Route{
			"PostSubmodelDescriptor",
			strings.ToUpper("Post"),
			"/api/v3/submodel-descriptors",
			c.PostSubmodelDescriptor,
		},
		"GetSubmodelDescriptorById": Route{
			"GetSubmodelDescriptorById",
			strings.ToUpper("Get"),
			"/api/v3/submodel-descriptors/{submodelIdentifier}",
			c.GetSubmodelDescriptorById,
		},
		"PutSubmodelDescriptorById": Route{
			"PutSubmodelDescriptorById",
			strings.ToUpper("Put"),
			"/api/v3/submodel-descriptors/{submodelIdentifier}",
			c.PutSubmodelDescriptorById,
		},
		"DeleteSubmodelDescriptorById": Route{
			"DeleteSubmodelDescriptorById",
			strings.ToUpper("Delete"),
			"/api/v3/submodel-descriptors/{submodelIdentifier}",
			c.DeleteSubmodelDescriptorById,
		},
	}
}

// OrderedRoutes returns all the api routes in a deterministic order for the SubmodelRegistryAPIAPIController
func (c *SubmodelRegistryAPIAPIController) OrderedRoutes() []Route {
	return []Route{
		Route{
			"GetAllSubmodelDescriptors",
			strings.ToUpper("Get"),
			"/api/v3/submodel-descriptors",
			c.GetAllSubmodelDescriptors,
		},
		Route{
			"PostSubmodelDescriptor",
			strings.ToUpper("Post"),
			"/api/v3/submodel-descriptors",
			c.PostSubmodelDescriptor,
		},
		Route{
			"GetSubmodelDescriptorById",
			strings.ToUpper("Get"),
			"/api/v3/submodel-descriptors/{submodelIdentifier}",
			c.GetSubmodelDescriptorById,
		},
		Route{
			"PutSubmodelDescriptorById",
			strings.ToUpper("Put"),
			"/api/v3/submodel-descriptors/{submodelIdentifier}",
			c.PutSubmodelDescriptorById,
		},
		Route{
			"DeleteSubmodelDescriptorById",
			strings.ToUpper("Delete"),
			"/api/v3/submodel-descriptors/{submodelIdentifier}",
			c.DeleteSubmodelDescriptorById,
		},
	}
}

// GetAllSubmodelDescriptors - Returns all Submodel Descriptors
func (c *SubmodelRegistryAPIAPIController) GetAllSubmodelDescriptors(w http.ResponseWriter, r *http.Request) {
	query, err := parseQuery(r.URL.RawQuery)
	if err != nil {
		log.Printf("ðŸ§© [%s] Error in GetAllSubmodelDescriptors: parse query raw=%q: %v", componentName, r.URL.RawQuery, err)
		result := common.NewErrorResponse(
			err,
			http.StatusBadRequest,
			componentName,
			"GetAllSubmodelDescriptors",
			"query",
		)
		_ = EncodeJSONResponse(result.Body, &result.Code, w)
		return
	}
	var limitParam int32
	if query.Has("limit") {
		param, err := parseNumericParameter[int32](
			query.Get("limit"),
			WithParse[int32](parseInt32),
			WithMinimum[int32](1),
		)
		if err != nil {
			log.Printf("ðŸ§© [%s] Error in GetAllSubmodelDescriptors: parse limit=%q: %v", componentName, query.Get("limit"), err)
			result := common.NewErrorResponse(
				err,
				http.StatusBadRequest,
				componentName,
				"GetAllSubmodelDescriptors",
				"limit",
			)
			_ = EncodeJSONResponse(result.Body, &result.Code, w)
			return
		}

		limitParam = param
	}
	var cursorParam string
	if query.Has("cursor") {
		param := query.Get("cursor")

		cursorParam = param
	}
	result, err := c.service.GetAllSubmodelDescriptors(r.Context(), limitParam, cursorParam)
	// If an error occurred, encode the error with the status code
	if err != nil {
		log.Printf("ðŸ§© [%s] Error in GetAllSubmodelDescriptors: service failure (limit=%d cursor=%q): %v", componentName, limitParam, cursorParam, err)
		c.errorHandler(w, r, err, &result)
		return
	}
	// If no error, encode the body and the result code
	_ = EncodeJSONResponse(result.Body, &result.Code, w)
}

// PostSubmodelDescriptor - Creates a new Submodel Descriptor, i.e. registers a submodel
func (c *SubmodelRegistryAPIAPIController) PostSubmodelDescriptor(w http.ResponseWriter, r *http.Request) {
	var submodelDescriptorParam SubmodelDescriptor
	d := json.NewDecoder(r.Body)
	d.DisallowUnknownFields()
	if err := d.Decode(&submodelDescriptorParam); err != nil {
		log.Printf("ðŸ§© [%s] Error in PostSubmodelDescriptor: decode body: %v", componentName, err)
		result := common.NewErrorResponse(
			err,
			http.StatusBadRequest,
			componentName,
			"PostSubmodelDescriptor",
			"RequestBody",
		)
		_ = EncodeJSONResponse(result.Body, &result.Code, w)
		return
	}
	if err := model.AssertSubmodelDescriptorRequired(submodelDescriptorParam); err != nil {
		log.Printf("ðŸ§© [%s] Error in PostSubmodelDescriptor: required validation failed: %v", componentName, err)
		result := common.NewErrorResponse(
			err,
			http.StatusBadRequest,
			componentName,
			"PostSubmodelDescriptor",
			"RequestBody",
		)
		_ = EncodeJSONResponse(result.Body, &result.Code, w)
		return
	}
	if err := model.AssertSubmodelDescriptorConstraints(submodelDescriptorParam); err != nil {
		log.Printf("ðŸ§© [%s] Error in PostSubmodelDescriptor: constraints validation failed: %v", componentName, err)
		result := common.NewErrorResponse(
			err,
			http.StatusBadRequest,
			componentName,
			"PostSubmodelDescriptor",
			"RequestBody",
		)
		_ = EncodeJSONResponse(result.Body, &result.Code, w)
		return
	}
	result, err := c.service.PostSubmodelDescriptor(r.Context(), submodelDescriptorParam)
	// If an error occurred, encode the error with the status code
	if err != nil {
		log.Printf("ðŸ§© [%s] Error in PostSubmodelDescriptor: service failure (bodyId=%q): %v", componentName, submodelDescriptorParam.Id, err)
		c.errorHandler(w, r, err, &result)
		return
	}
	// If no error, encode the body and the result code
	_ = EncodeJSONResponse(result.Body, &result.Code, w)
}

// GetSubmodelDescriptorById - Returns a specific Submodel Descriptor
func (c *SubmodelRegistryAPIAPIController) GetSubmodelDescriptorById(w http.ResponseWriter, r *http.Request) {
	submodelIdentifierParam := chi.URLParam(r, "submodelIdentifier")
	if submodelIdentifierParam == "" {
		log.Printf("ðŸ§© [%s] Error in GetSubmodelDescriptorById: missing path parameter submodelIdentifier", componentName)
		result := common.NewErrorResponse(
			common.NewErrBadRequest("Missing path parameter 'submodelIdentifier'"),
			http.StatusBadRequest,
			componentName,
			"GetSubmodelDescriptorById",
			"submodelIdentifier",
		)
		_ = EncodeJSONResponse(result.Body, &result.Code, w)
		return
	}
	result, err := c.service.GetSubmodelDescriptorById(r.Context(), submodelIdentifierParam)
	// If an error occurred, encode the error with the status code
	if err != nil {
		log.Printf("ðŸ§© [%s] Error in GetSubmodelDescriptorById: service failure (submodelIdentifier=%q): %v", componentName, submodelIdentifierParam, err)
		c.errorHandler(w, r, err, &result)
		return
	}
	// If no error, encode the body and the result code
	_ = EncodeJSONResponse(result.Body, &result.Code, w)
}

// PutSubmodelDescriptorById - Creates or updates an existing Submodel Descriptor
func (c *SubmodelRegistryAPIAPIController) PutSubmodelDescriptorById(w http.ResponseWriter, r *http.Request) {
	submodelIdentifierParam := chi.URLParam(r, "submodelIdentifier")
	if submodelIdentifierParam == "" {
		log.Printf("ðŸ§© [%s] Error in PutSubmodelDescriptorById: missing path parameter submodelIdentifier", componentName)
		result := common.NewErrorResponse(
			common.NewErrBadRequest("Missing path parameter 'submodelIdentifier'"),
			http.StatusBadRequest,
			componentName,
			"PutSubmodelDescriptorById",
			"submodelIdentifier",
		)
		_ = EncodeJSONResponse(result.Body, &result.Code, w)
		return
	}
	var submodelDescriptorParam SubmodelDescriptor
	d := json.NewDecoder(r.Body)
	d.DisallowUnknownFields()
	if err := d.Decode(&submodelDescriptorParam); err != nil {
		log.Printf("ðŸ§© [%s] Error in PutSubmodelDescriptorById: decode body: %v", componentName, err)
		result := common.NewErrorResponse(
			err,
			http.StatusBadRequest,
			componentName,
			"PutSubmodelDescriptorById",
			"RequestBody",
		)
		_ = EncodeJSONResponse(result.Body, &result.Code, w)
		return
	}
	if err := model.AssertSubmodelDescriptorRequired(submodelDescriptorParam); err != nil {
		log.Printf("ðŸ§© [%s] Error in PutSubmodelDescriptorById: required validation failed: %v", componentName, err)
		result := common.NewErrorResponse(
			err,
			http.StatusBadRequest,
			componentName,
			"PutSubmodelDescriptorById",
			"RequestBody",
		)
		_ = EncodeJSONResponse(result.Body, &result.Code, w)
		return
	}
	if err := model.AssertSubmodelDescriptorConstraints(submodelDescriptorParam); err != nil {
		log.Printf("ðŸ§© [%s] Error in PutSubmodelDescriptorById: constraints validation failed: %v", componentName, err)
		result := common.NewErrorResponse(
			err,
			http.StatusBadRequest,
			componentName,
			"PutSubmodelDescriptorById",
			"RequestBody",
		)
		_ = EncodeJSONResponse(result.Body, &result.Code, w)
		return
	}
	result, err := c.service.PutSubmodelDescriptorById(r.Context(), submodelIdentifierParam, submodelDescriptorParam)
	// If an error occurred, encode the error with the status code
	if err != nil {
		log.Printf("ðŸ§© [%s] Error in PutSubmodelDescriptorById: service failure (submodelIdentifier=%q bodyId=%q): %v", componentName, submodelIdentifierParam, submodelDescriptorParam.Id, err)
		c.errorHandler(w, r, err, &result)
		return
	}
	// If no error, encode the body and the result code
	_ = EncodeJSONResponse(result.Body, &result.Code, w)
}

// DeleteSubmodelDescriptorById - Deletes a Submodel Descriptor, i.e. de-registers a submodel
func (c *SubmodelRegistryAPIAPIController) DeleteSubmodelDescriptorById(w http.ResponseWriter, r *http.Request) {
	submodelIdentifierParam := chi.URLParam(r, "submodelIdentifier")
	if submodelIdentifierParam == "" {
		log.Printf("ðŸ§© [%s] Error in DeleteSubmodelDescriptorById: missing path parameter submodelIdentifier", componentName)
		result := common.NewErrorResponse(
			common.NewErrBadRequest("Missing path parameter 'submodelIdentifier'"),
			http.StatusBadRequest,
			componentName,
			"DeleteSubmodelDescriptorById",
			"submodelIdentifier",
		)
		_ = EncodeJSONResponse(result.Body, &result.Code, w)
		return
	}
	result, err := c.service.DeleteSubmodelDescriptorById(r.Context(), submodelIdentifierParam)
	// If an error occurred, encode the error with the status code
	if err != nil {
		log.Printf("ðŸ§© [%s] Error in DeleteSubmodelDescriptorById: service failure (submodelIdentifier=%q): %v", componentName, submodelIdentifierParam, err)
		c.errorHandler(w, r, err, &result)
		return
	}
	// If no error, encode the body and the result code
	_ = EncodeJSONResponse(result.Body, &result.Code, w)
}
